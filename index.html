<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit DOJ Forms</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
</head>
<body>
    <!-- Main Home Page -->
    <div id="homePage" class="container">
        <header>
            <h1>Select a DOJ Form</h1>
        </header>

        <p>Select a form to open and edit:</p>
        <div class="buttons-container" id="pdfList">
            <!-- PDF buttons will go here -->
        </div>
    </div>

    <!-- PDF Editor Page -->
    <div id="editorPage" class="container" style="display:none;">
        <header>
            <h1>Editing PDF: <span id="currentPdfName"></span></h1>
        </header>

        <canvas id="pdfCanvas" width="600" height="800"></canvas>
        <br/>
        <button id="downloadPdf" style="display:none;" class="styled-button green">Download Edited PDF</button>
        <button id="backButton" class="styled-button red">Back to Home</button>
    </div>

    <script>
        const pdfFiles = [
            'Answer to Complaint.pdf',
            'Appearance.pdf',
            'Application for a Search Warrant.pdf',
            'Appointment of Counsel.pdf',
            'Arrest Warrant.pdf',
            'Civil Complaint.pdf',
            'Court Response to Motion.pdf',
            'Criminal Complaint.pdf',
            'Judgement in a Civil Action.pdf',
            'Motion for Contempt.pdf',
            'Motion for Enlargement of Time.pdf',
            'Motion to Dismiss.pdf',
            'Motion to Reconsider.pdf',
            'Name Change Request.pdf',
            'Notice of Suit.pdf',
            'Pre Filing.pdf',
            'Response to Motion.pdf',
            'Search and Seizure Warrant.pdf',
            'Subpoena Discovery.pdf',
            'Subpoena to Testify at Criminal.pdf',
            'Subpoena to Testify.pdf',
            'Substitution of Attorney.pdf'
        ];

        const pdfFolder = './pdfs/';
        const pdfList = document.getElementById('pdfList');
        const canvas = document.getElementById('pdfCanvas');
        const currentPdfNameSpan = document.getElementById('currentPdfName');
        const downloadButton = document.getElementById('downloadPdf');
        const homePage = document.getElementById('homePage');
        const editorPage = document.getElementById('editorPage');
        const backButton = document.getElementById('backButton');
        let currentPdfBytes = null;
        let currentPdfDoc = null;

        // Create buttons dynamically for each PDF
        pdfFiles.forEach(pdf => {
            const button = document.createElement('button');
            button.innerText = pdf.replace('.pdf', ''); // Button text without '.pdf'
            button.className = 'styled-button';
            button.onclick = () => openPdfEditor(pdf);
            pdfList.appendChild(button);
        });

        // Open PDF in Editor and prepare for editing
        async function openPdfEditor(pdfFileName) {
            const pdfUrl = pdfFolder + pdfFileName;
            currentPdfNameSpan.innerText = pdfFileName;
            homePage.style.display = 'none';
            editorPage.style.display = 'block';
            downloadButton.style.display = 'none';

            // Fetch the PDF file
            currentPdfBytes = await fetch(pdfUrl).then(res => res.arrayBuffer());
            
            // Load the PDF using PDF-Lib for editing
            currentPdfDoc = await PDFLib.PDFDocument.load(currentPdfBytes);
            const pages = currentPdfDoc.getPages();
            const firstPage = pages[0]; // Example: editing the first page

            // Example: Add field editing (adjust based on real fields in your PDF)
            const form = currentPdfDoc.getForm();
            const textField = form.getTextField('Name'); // Replace 'Name' with actual field name
            if (textField) {
                textField.setText('John Doe'); // Example fill
            }

            // Render the first page using PDF.js for a visual preview (optional)
            const loadingTask = pdfjsLib.getDocument({ data: currentPdfBytes });
            loadingTask.promise.then(function(pdf) {
                pdf.getPage(1).then(function(page) {
                    const scale = 1.5;
                    const viewport = page.getViewport({ scale: scale });

                    // Prepare canvas using PDF page dimensions
                    const canvasContext = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    // Render PDF page into canvas context
                    const renderContext = {
                        canvasContext: canvasContext,
                        viewport: viewport
                    };
                    page.render(renderContext).promise.then(function() {
                        console.log('Page rendered');
                    });
                });
            });

            // Show download button after rendering
            downloadButton.style.display = 'inline-block';
            downloadButton.onclick = () => downloadEditedPdf(pdfFileName);
        }

        // Download the edited PDF
        async function downloadEditedPdf(pdfFileName) {
            const editedPdfBytes = await currentPdfDoc.save(); // Save the modified PDF

            // Create a Blob for downloading
            const blob = new Blob([editedPdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `edited-${pdfFileName}`;
            a.click();
        }

        // Go back to home page
        backButton.onclick = () => {
            editorPage.style.display = 'none';
            homePage.style.display = 'block';
        };
    </script>
</body>
</html>
